---
title: "EMTscoreData Package"
author: "haimei wen"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{EMTscoreData Vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# 1. Introduction of EMTscoreData
EMTscoreData is an R ExperimentHub package that provides curated gene expression datasets for benchmarking and developing epithelial–mesenchymal transition (EMT) scoring methods. In future updates, we will add more EMT datasets to facilitate users in conducting EMT-related research. This package is now prepared as the companion dataset for the upcoming EMTscore R package.

# 2. Installation
## Install the development version from GitHub
```{r install_github, eval=FALSE}
# install.packages("devtools")
#devtools::install_github("wenmm/EMTscore")
#devtools::install_github("wenmm/EMTscoreData")
```

## Install from Bioconductor (recommended once available):
```{r install}
#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")

#BiocManager::install("EMTscore")
#BiocManager::install("EMTscoreData")
```

# 3. Download data from the EMTscoreData R package
You can obtain the datasets included in this package through the `ExperimentHub` framework. To start, use query() to inspect all records associated with the `EMTscoreData` package, which will show you the available resources along with their corresponding identifiers. After identifying the items of interest, you can download them directly from the hub.
```{r}
library(EMTscoreData)
#library(EMTscore)
library(ExperimentHub)
library(SummarizedExperiment)
library(Seurat)
library(ggplot2)
eh = ExperimentHub()
query(eh , 'EMTscoreData')
```

## Download data using the unique identifier:
```{r}
A549_TNF <- eh[['EH10291']]
A549_EGF <- eh[['EH10292']]
A549_TGFB1 <- eh[['EH10293']]
```

# 4. Data analysis and visualization

## 4.1 Load gene set data
```{r}
#library("EMTscore")
#data("Panchy_et_al_E_signature", package = "EMTscore")
#data("Panchy_et_al_M_signature", package = "EMTscore")
url <- "https://zenodo.org/records/17917654/files/HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION.v2025.1.Hs.gmt"
gmt_file <- tempfile(fileext = ".gmt")
download.file(url, gmt_file, mode = "wb")


read_gmt <- function(fname){
  gmt_lines <- readLines(fname)
  gmt_list <- lapply(gmt_lines, function(x) unlist(strsplit(x, split="\t")))
  gmt_genes <- lapply(gmt_list, function(x) x[3:length(x)])
  genes <- unique(unlist(gmt_genes))
  return(data.frame(gene = genes, stringsAsFactors = FALSE))
}

Genesets <- read_gmt(gmt_file)
```


## 4.2 Calculating EMT Scores for Datasets Stored in EMTscoreData
Calculated EMT scores can then be plotted against pseudotime to examine dynamic changes in epithelial–mesenchymal states.
```{r}
objects <- list(
A549_TGFB1 = A549_TGFB1,
A549_EGF   = A549_EGF,
A549_TNF   = A549_TNF
)

emt_genes <- Genesets$gene

add_EMT_score <- function(objects,
                          gmt_file,
                          emt_name = "EMT_Score") {
  
  Genesets <- read_gmt(gmt_file)
  emt_genes <- Genesets$gene
  
  obj_list <- lapply(names(objects), function(name) {
    
    obj <- objects[[name]]
    
    # Convert SCE → Seurat
    if (inherits(obj, "SingleCellExperiment")) {
      message("Converting SCE to Seurat: ", name)
      obj <- as.Seurat(obj, data = "logcounts")
    }
    if (!inherits(obj, "Seurat")) {
      stop("Object ", name, " is not a Seurat or SCE object.")
    }
    
    obj <- UpdateSeuratObject(obj)
    
    # get gene expression matrix
    geneExp <- GetAssayData(obj, assay = "RNA", layer = "data")
    
      
    obj <- AddModuleScore(obj, features = list(emt_genes), name = emt_name, ctrl = 5)
    colnames(obj@meta.data)[colnames(obj@meta.data) == paste0(emt_name, "1")] <- emt_name
      
    
    return(obj)
  })
  
  names(obj_list) <- names(objects)
  return(obj_list)
}

plot_EMT_from_objects <- function(obj_list, col_name,
                                  emt_score_col) {
  
  # Merge all Seurat object meta.data
  plot_df <- do.call(rbind, lapply(names(obj_list), function(name) {
    obj <- obj_list[[name]]
    df <- obj@meta.data[, c(col_name, emt_score_col), drop = FALSE]
    colnames(df) <- c(col_name, emt_score_col)
    df$Condition <- name
    df <- df[order(df[[col_name]]), ]  
    df
  }))
  
  # Draw smooth curves
  p <- ggplot(plot_df, aes_string(x = col_name, y = emt_score_col, color = "Condition")) +
    geom_smooth(method = "loess", se = FALSE, linewidth = 1.2) +
    theme_classic(base_size = 14) +
    labs(x = col_name, y = emt_score_col, color = "Condition")
  
  return(p)
}

seurat_objs <- add_EMT_score(objects, gmt_file = gmt_file, emt_name = "EMT_score")
p_AUCell <- plot_EMT_from_objects(seurat_objs, col_name = "Pseudotime", emt_score_col = "EMT_score")
p_AUCell
```



```{r}
sessionInfo()
```
